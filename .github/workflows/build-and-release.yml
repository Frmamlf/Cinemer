name: Build and Release APK

on:
  push:
    branches: [ main, master ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'zulu'
        java-version: '17'
        
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.22.0'
        channel: 'stable'
        
    - name: Get dependencies
      working-directory: ./mobile
      run: flutter pub get
      
    - name: Analyze code
      working-directory: ./mobile
      run: flutter analyze --no-fatal-infos
      
    - name: Create missing asset directories
      working-directory: ./mobile
      run: |
        mkdir -p assets/images
        mkdir -p assets/animations
        
    - name: Build APK (Debug)
      working-directory: ./mobile
      run: flutter build apk --debug
      
    - name: Build APK (Release)
      working-directory: ./mobile
      run: flutter build apk --release
      
    - name: Build App Bundle (Release)
      working-directory: ./mobile
      run: flutter build appbundle --release
      
    - name: Upload Debug APK
      uses: actions/upload-artifact@v4
      with:
        name: cinemer-debug-apk
        path: mobile/build/app/outputs/flutter-apk/app-debug.apk
        
    - name: Upload Release APK
      uses: actions/upload-artifact@v4
      with:
        name: cinemer-release-apk
        path: mobile/build/app/outputs/flutter-apk/app-release.apk
        
    - name: Upload Release App Bundle
      uses: actions/upload-artifact@v4
      with:
        name: cinemer-release-aab
        path: mobile/build/app/outputs/bundle/release/app-release.aab

  release:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Download Release APK
      uses: actions/download-artifact@v4
      with:
        name: cinemer-release-apk
        path: ./release-artifacts
        
    - name: Download Release App Bundle
      uses: actions/download-artifact@v4
      with:
        name: cinemer-release-aab
        path: ./release-artifacts
        
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          ./release-artifacts/app-release.apk
          ./release-artifacts/app-release.aab
        name: Cinemer ${{ github.ref_name }}
        body: |
          # Cinemer - Movie, TV Shows & Anime App
          
          ## ðŸ“± Download Options
          - **APK**: Universal Android app file (install directly)
          - **AAB**: Android App Bundle (for Google Play Store)
          
          ## âœ¨ Features
          - Browse popular, top-rated, and upcoming movies
          - Discover TV shows and anime
          - Search across all content types
          - User authentication with TMDB
          - Material You design with adaptive themes
          - Smooth animations and modern UI
          
          ## ðŸ”§ API Configuration
          This app uses TMDB (The Movie Database) API. The app comes pre-configured with a valid API key for immediate use.
          
          ## ðŸ“‹ Installation
          1. Download the APK file
          2. Enable "Install from Unknown Sources" in Android settings
          3. Install the APK
          4. Enjoy browsing movies, TV shows, and anime!
          
          Built with Flutter ðŸ’™
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
